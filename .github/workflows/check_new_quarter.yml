name: Check for New Quarter and Update Deployed Terms If Needed

on:
    schedule:
        - cron: '0 * * * *'
    workflow_dispatch:

env:
    ANTEATER_API_KEY: ${{ secrets.ANTEATER_API_KEY }}

permissions:
    contents: write

jobs:
    check-quarters:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Check for new terms
              id: check
              run: |
                  echo "Fetching latest terms from AnteaterAPI..."
                  API_RESPONSE=$(
                    curl -s https://anteaterapi.com/v2/rest/websoc/terms \
                    -H "Authorization: Bearer $ANTEATER_API_KEY" \
                    -H "Origin: https://antalmanac.com"
                  )


                  if ! echo "$API_RESPONSE" | jq empty 2>/dev/null; then
                      echo "Error: AnteaterAPI returned invalid JSON"
                      exit 1
                  fi

                  LATEST_TERM=$(echo "$API_RESPONSE" | jq -r '.data[0].longName // empty')

                  if [[ -z "$LATEST_TERM" ]]; then
                      echo "Error: AnteaterAPI returned an empty response"
                      exit 1
                  fi

                  if [[ ! -f .github/deployed_terms.json ]]; then
                      echo "deployed_terms.json does not exist"
                      echo "Creating initial deployed_terms.json..."
                      echo "$API_RESPONSE" > .github/deployed_terms.json
                      {
                        echo "update_needed=true"
                        echo "new_term=$LATEST_TERM"
                        echo "reason=initial deployed terms tracking file not generated"
                      } >> $GITHUB_OUTPUT

                      exit 0
                  fi

                  LATEST_DEPLOYED=$(jq -r '.data[0].longName // empty' .github/deployed_terms.json)

                  echo "Latest term from API: $LATEST_TERM"
                  echo "Latest deployed term: $LATEST_DEPLOYED"

                  if [[ "$LATEST_DEPLOYED" == "$LATEST_TERM" ]]; then
                      echo "No new quarter found"
                      echo "update_needed=false" >> $GITHUB_OUTPUT
                  else
                      echo "New quarter detected!"
                      echo "$API_RESPONSE" > .github/deployed_terms.json
                      {
                          echo "update_needed=true"
                          echo "new_term=$LATEST_TERM"
                          echo "reason=new quarter available, trigger rebuild"
                      } >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push updated terms
              if: steps.check.outputs.update_needed == 'true'
              run: |
                  git add .github/deployed_terms.json
                  git commit -m "ci: ${{ steps.check.outputs.reason }}" \
                             -m "New term: ${{ steps.check.outputs.new_term }}" \
                             -m "Auto-updated by workflow on $(date -u +%Y-%m-%d)"

                  git pull --rebase origin ${{ github.ref_name }}
                  git push
                  echo "Updated deployed_terms.json and triggered rebuild"
